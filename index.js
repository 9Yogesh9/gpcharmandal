const API_URL="https://script.google.com/macros/s/AKfycbzv0atIeO7T0OgChoTj9W9_vqzo9IJ1zPh5hHGRYqWvIidjkJ0DNmHa1P-XGgBCUqWV/exec",$=e=>document.getElementById(e)||null,elements={notice_board_content:$("notice_board_content"),todaysdate:$("todaysdate"),wimage:$("wimage"),temp:$("temp"),sunrise:$("sunrise"),sunset:$("sunset"),dynamicData:$("dynamicData"),samitiImage:$("samitiImage"),samitiLabel:$("samitiLabel"),upkramImage:$("upkramImage"),upkramLabel:$("upkramLabel"),puraskarImage:$("puraskarImage"),puraskarLabel:$("puraskarLabel"),paymentQR:$("qrImage"),myModal:$("exampleModal"),myInput:$("myInput"),unlockForm:$("unlockCredentials"),unlockModal:$("unlockModal"),complaintForm:$("complaintForm"),resolutionForm:$("resolutionForm"),complaintModal:$("complaint"),resolutionModal:$("resolutionmodal"),complaintList:$("complaintList"),complaintSearchForm:$("complaintSearchForm"),complaintSearchModal:$("complaintSearchModal"),publicComplaintContainer:$("publicComplaintContainer"),complaintListPublic:$("complaintList_public"),houseNumberForm:$("houseNumberForm"),houseModal:$("houseModal"),taxDetailModal:$("taxDetailModal"),logout:$("logout"),loginCredentials:$("loginCredentials"),loginModal:$("loginModal"),bannerContainer:$("banner_display"),bannerContent:$("apicalled"),login:$("login"),takrarlist:$("takrarlist"),multiLinkContainer:$("multi_link_container"),name:$("name"),holdId:$("holdId"),mobile:$("mobile"),details1:$("details1"),solution:$("solution"),resolutionUpdateButton:$("resolutionUpdateButton"),paymentButton:$("paymentButton"),viewCount:$("viewCount"),locker:$("locker"),gpstructuredata:$("gpstructuredata"),news1card:$("news1card"),news1image:$("news1image"),news1title:$("news1title"),news1text:$("news1text"),news2card:$("news2card"),news2image:$("news2image"),news2title:$("news2title"),news2text:$("news2text"),newscontainer:$("newscontainer")},modals={complaint:bootstrap.Modal.getOrCreateInstance(elements.complaintModal),resolution:bootstrap.Modal.getOrCreateInstance(elements.resolutionModal),complaintSearch:bootstrap.Modal.getOrCreateInstance(elements.complaintSearchModal),house:bootstrap.Modal.getOrCreateInstance(elements.houseModal),taxDetail:bootstrap.Modal.getOrCreateInstance(elements.taxDetailModal),login:bootstrap.Modal.getOrCreateInstance(elements.loginModal)},getTodaysDate=()=>{const e=new Date;return`${e.getDate()}-${e.getMonth()+1}-${e.getFullYear()}`},toggleLoadingBanner=(e="")=>{const{bannerContainer:t,bannerContent:n}=elements,a="flex"===t.style.display;t.style.display=a?"none":"flex",n.textContent=e},toggleDisplays=()=>{const e=JSON.parse(localStorage.getItem("userSession")||"{}").userLoggedin||!1,{takrarlist:t,logout:n,login:a,multiLinkContainer:o}=elements;t.style.display=e?"block":"none",n.style.display=e?"block":"none",a.style.display=e?"none":"block",o.style.display=e?"block":"none"},toggleSamitiURL=(e,t)=>{samitiLabel.innerText=t,samitiImage.setAttribute("src",e)},togglePuraskarURL=(e,t)=>{puraskarLabel.innerText=t,puraskarImage.setAttribute("src",e)},toggleUpkramURL=(e,t)=>{upkramLabel.innerText=t,upkramImage.setAttribute("src",e)},toggleResolution=(e,t)=>{const n="general"==t?JSON.parse(localStorage.getItem("complaintsList")||"[]").filter((t=>{if(t.UniqueID===e)return t})):JSON.parse(localStorage.getItem("complaints")||"[]").filter((t=>{if(t.UniqueID===e)return t})),a=n[0];if(a){const{name:e,mobile:n,details1:o,holdId:l,solution:s}=elements;e.value=a.Name,n.value=a["Mobile Number"],o.value=a.Details,l.value=a.UniqueID,"general"==t?(s.value=a.Resolution||"आपल्या तक्रारीवर काम सुरू आहे",s.readOnly=!0,s.classList.add("bg-dark-subtle"),elements.resolutionUpdateButton.style.display="none"):(s.value=a.Resolution||"",s.readOnly=!1,s.classList.remove("bg-dark-subtle"),elements.resolutionUpdateButton.style.display="block")}else console.log("Error happened while searching for the complaint in localdatabase "+e)},weatherIconMap={"01d":"01","01n":"01","02d":"02","02n":"02","03d":"03","03n":"03","04d":"04","04n":"04","09d":"09","09n":"09","10d":"10","10n":"10","11d":"11","11n":"11","13d":"13","13n":"13","50d":"50","50n":"50"},getViewsAndWeather=async()=>{const e=await fetch(`${API_URL}?Method=getViewsAndWeather`);let{Views:t,Weather:n,gpStructure:a,news:o}=await e.json();if(!e.ok)throw new Error(`Failed to fetch view count. Status: ${e.status}`);a.gpstructData.length>0&&populateGPStructure(a.gpstructData),console.log(o),loadNews(o),elements.todaysdate.innerText=n.dt,elements.wimage.setAttribute("src",`asset/Weather/${weatherIconMap[n.icon]}.png`),elements.temp.innerText=n.temp,elements.sunrise.innerText=n.sunrise,elements.sunset.innerText=n.sunset,elements.viewCount.innerText=t,elements.notice_board_content.style.display="block"};function loadNews(e){0==e.length||"Publish"!=e[0][3]&&"Publish"!=e[1][3]||(elements.newscontainer.style.display="block","Publish"==e[0][3]&&(elements.news1card.style.display="block",""==e[0][2]?elements.news1image.style="background:url('asset/images/news_placeholder.png') center/cover; border-radius: 1rem 1rem 0px 0px; width: 95%; height: 16rem;":elements.news1image.style=`background:url('https://drive.google.com/thumbnail?id=${e[0][2]}&sz=w1000') center/cover; border-radius: 1rem 1rem 0px 0px; width: 95%; height: 16rem;`,elements.news1title.innerText=e[0][1],elements.news1text.innerText=e[0][0]),"Publish"==e[1][3]&&(elements.news2card.style.display="block",""==e[1][2]?elements.news2image.style="background:url('asset/images/news_placeholder.png') center/cover; border-radius: 1rem 1rem 0px 0px; width: 95%; height: 16rem;":elements.news2image.style=`background:url('https://drive.google.com/thumbnail?id=${e[1][2]}&sz=w1000') center/cover; border-radius: 1rem 1rem 0px 0px; width: 95%; height: 16rem;`,elements.news2title.innerText=e[0][1],elements.news2text.innerText=e[1][0]))}function populateGPStructure(e){let t="",n=!0;e.forEach((e=>{n?n=!1:e[1]&&""!=e[1]&&(""!=e[3]?t+=`<div class="card" style="border: none;display: flex; align-items: center;margin-top: 1.3rem;">\n  <div class="card-img-top structure_card_img" style="background:url('https://drive.google.com/thumbnail?id=${e[3]}&sz=w1000') center/cover; width: 11rem; height: 11rem;"></div>`:t+='<div class="card" style="border: none;display: flex; align-items: center;margin-top: 1.3rem;">\n  <div class="card-img-top structure_card_img" style="background:url(\'asset/images/userprof.webp\') center/cover; width: 11rem; height: 11rem;"></div>',t+=`\n  <div class="card-body" style="padding:0px; margin-top:0.5rem;">\n  <ul class="list-group list-group-flush">\n  <li class="list-group-item fw-semibold name_plate" style="color:white">${e[0]}</li>\n  <li class="list-group-item fw-semibold name_plate" style="color:white">${e[1]}</li>\n  <li class="list-group-item fw-semibold name_plate"><a href="tel:${e[2]}" style="color: white;">${e[2]}</a></li>\n  </div>\n</div>`)})),elements.gpstructuredata.innerHTML=t}const fetchComplaints=async()=>{try{localStorage.removeItem("complaints"),toggleLoadingBanner("तक्रारी लोड करत आहे");const e=await fetch(`${API_URL}?Method=readAllData`);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const{secret:t,gpdata:n}=await e.json();localStorage.setItem("secret",t);const{complaintColumns:a,complaintData:o}=n,l=a[0],s=o.map((e=>e.reduce(((e,t,n)=>({...e,[l[n]]:t})),{})));localStorage.setItem("complaints",JSON.stringify(s)),localStorage.setItem("complaint_columns",JSON.stringify(a)),loadComplaints()}catch(e){console.error("Fetch complaints error:",e)}finally{toggleLoadingBanner()}},loadComplaints=()=>{const e=JSON.parse(localStorage.getItem("complaints")||"[]");elements.complaintList.innerHTML="",e.forEach(((e,t)=>{const n=document.createElement("a");n.textContent=`${t+1}. नाव: ${e.Name}, मोबाईल: ${e["Mobile Number"]}, तपशील: ${e.Details}, तारीख: ${e.Created.substring(0,10)}${e.Resolution?`, तक्रार निवारण: ${e.Resolution}`:""}`,n.href="#",n.classList.add("list-group-item","list-group-item-action","list-group-item-primary","poppins-regular","col-2","text-truncate");let a=e.UniqueID;n.dataset.bsToggle="modal",n.dataset.bsTarget="#resolutionmodal",n.addEventListener("click",(function(){toggleResolution(a,"admin")})),elements.complaintList.appendChild(n)}))},fetchComplaintStatus=async()=>{try{localStorage.removeItem("userComplaintList");const e=document.getElementById("mobile_search").value.trim(),t=document.getElementById("name_search").value.trim(),n=document.getElementById("id_search").value.trim();elements.complaintSearchForm.reset(),modals.complaintSearch.hide(),toggleLoadingBanner("तुमच्या तक्रारी शोधत आहे");const a=await fetch(`${API_URL}?Method=${encodeURIComponent("filteredData")}&Name=${encodeURIComponent(t)}&Mobile=${encodeURIComponent(e)}&UniqueID=${encodeURIComponent(n)}`);if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);const o=await a.json();if(o.complaintData.length>0){const{complaintColumns:e,complaintData:t}=o,n=e[0],a=t.map((e=>e.reduce(((e,t,a)=>({...e,[n[a]]:t})),{})));localStorage.setItem("complaint_columns",JSON.stringify(e)),localStorage.setItem("complaintsList",JSON.stringify(a)),elements.publicComplaintContainer.style.display="block",loadPublicComplaints()}else alert("कुठलेही तक्रारी आढळल्या नाहीत, कृपया पुन्हा प्रयत्न करा")}catch(e){console.error("Fetch complaint status error:",e)}finally{toggleLoadingBanner()}},loadPublicComplaints=()=>{const e=JSON.parse(localStorage.getItem("complaintsList")||"[]");elements.complaintListPublic.innerHTML="",e.forEach(((e,t)=>{const n=document.createElement("a");n.textContent=`${t+1}. नाव: ${e.Name}, मोबाईल: ${e["Mobile Number"]}, तपशील: ${e.Details}, तारीख: ${e.Created.substring(0,10)}${e.Resolution?`, तक्रार निवारण: ${e.Resolution}`:""}`,n.href="#",n.classList.add("list-group-item","list-group-item-action","list-group-item-primary","text-truncate","col-2");const a=e.UniqueID;n.dataset.bsToggle="modal",n.dataset.bsTarget="#resolutionmodal",n.addEventListener("click",(function(){toggleResolution(a,"general")})),elements.complaintListPublic.appendChild(n)}))};document.addEventListener("DOMContentLoaded",(()=>{elements.complaintForm.addEventListener("submit",(async e=>{e.preventDefault();const t=document.getElementById("user_name").value.trim(),n=document.getElementById("mobile_number").value.trim(),a=document.getElementById("details").value.trim(),o=getTodaysDate(),l=Date.now();if(/^\d{10}$/.test(n)){elements.complaintForm.reset(),modals.complaint.hide(),toggleLoadingBanner("तक्रार सबमिट करत आहे");try{const e=await fetch(API_URL,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:`Name=${encodeURIComponent(t)}&Mobile=${encodeURIComponent(n)}&Details=${encodeURIComponent(a)}&Method=createNewRecord&Created=${o}&UniqueID=${l}`}),s=await e.text();alert(`तक्रार यशस्वीरित्या दाखल करण्यात आली\n तुमचा तक्रार रेफरन्स क्रमांक : ${s}`),JSON.parse(localStorage.getItem("userSession")||"{}").userLoggedin&&fetchComplaints()}catch(e){console.error("Complaint submission error:",e)}finally{toggleLoadingBanner()}}else alert("कृपया वैध मोबाइल नंबर एंटर करा.")})),elements.resolutionForm.addEventListener("submit",(async e=>{e.preventDefault();const t=document.getElementById("holdId").value.trim(),n=document.getElementById("solution").value.trim();try{toggleLoadingBanner("तक्रार अपडेट करत आहे"),elements.resolutionForm.reset(),modals.resolution.hide();const e=JSON.parse(localStorage.getItem("complaints")||"[]"),a=e.find((e=>e.UniqueID==t));(await fetch(API_URL,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:`Resolution=${encodeURIComponent(n)}&UniqueID=${encodeURIComponent(a.UniqueID)}&Method=updateResolution&Updated=${getTodaysDate()}`})).ok&&(a.Resolution=n,localStorage.setItem("complaints",JSON.stringify(e)),loadComplaints(),alert("तक्रार यशस्वीपणे अपडेट केली"))}catch(e){console.error("Resolution update error:",e)}finally{toggleLoadingBanner()}})),elements.complaintSearchForm.addEventListener("submit",(e=>{e.preventDefault(),fetchComplaintStatus()})),elements.houseNumberForm.addEventListener("submit",(async e=>{e.preventDefault();const t=document.getElementById("houseNumber").value.trim();modals.house.hide(),toggleLoadingBanner("कर माहिती शोधत आहे");try{const e=await fetch(`${API_URL}?Method=getTaxDetails&HouseNumber=${encodeURIComponent(t)}`);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const n=await e.json();if(n.dataFound){for(const[e,t]of Object.entries(n)){const n=document.getElementById(e);n&&(n.textContent=t)}elements.paymentQR.setAttribute("src",`https://quickchart.io/qr?text=upi%3A%2F%2Fpay%3Fpn%3DGPCharmandal%26pa%3Dboism-9604034441%40boi%26am%3D${n.totalTax}&size=160`),elements.paymentButton.href=`upi://pay?pn=Yogesh&pa=havefun@axisb&cu=INR&am=${n.totalTax}`,modals.taxDetail.show()}else alert("अयोग्य घर क्रमांक, कृपया पुन्हा प्रयत्न करा")}catch(e){console.error("Tax details fetch error:",e)}finally{toggleLoadingBanner()}})),elements.logout.addEventListener("click",(()=>{localStorage.setItem("userSession",JSON.stringify({userLoggedin:!1})),toggleDisplays()})),elements.loginCredentials.addEventListener("submit",(async t=>{t.preventDefault();const n=document.getElementById("password").value.trim();toggleLoadingBanner("प्रवेश तपासत आहे"),elements.loginCredentials.reset(),modals.login.hide();const a=await fetch(`${API_URL}?Method=${encodeURIComponent("getAdminToken")}&adminKey=${encodeURIComponent(n)}`);if(!a.ok)throw new Error(`HTTP errorin validating admin: ${a.status}`);"access granted"===await a.text()?(localStorage.setItem("userSession",JSON.stringify({userLoggedin:!0})),toggleLoadingBanner(),e(),fetchComplaints(),toggleDisplays()):alert("Invalid Password")}));const e=()=>{setTimeout((()=>{localStorage.setItem("userSession",JSON.stringify({userLoggedin:!1})),alert("Session Expired !"),toggleDisplays()}),36e5)};function t(e,t){e&&e.addEventListener("input",(()=>{const n=e.value.trim(),a=t(n);e.classList.toggle("is-valid",a),e.classList.toggle("is-invalid",!a)}))}getViewsAndWeather(),loadComplaints(),toggleDisplays(),t($("user_name"),(e=>/^[\p{L}]{2,}(?: [\p{L}]+)*$/u.test(e))),[$("mobile_number"),$("mobile_search")].forEach((e=>{t(e,(e=>/^\d{10}$/.test(e)))})),t($("id_search"),(e=>13===e.length)),document.querySelectorAll&&document.querySelectorAll("img").forEach((e=>{e.hasAttribute("loading")||e.setAttribute("loading","lazy")}))}));